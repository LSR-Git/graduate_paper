# Covasim 网络参数传递说明

## 网络参数概述

网络参数是按**层（layer）**设置的字典，主要包括：
- `contacts`: 每层的接触数
- `beta_layer`: 每层的传播率
- `dynam_layer`: 哪些层是动态的
- `iso_factor`: 隔离因子（按层）
- `quar_factor`: 隔离因子（按层）

## 不同人口类型的层结构

### 1. 'random' 类型
- 只有一层：`'a'` (all，所有接触)
- 默认值：
  ```python
  contacts = {'a': 20}
  beta_layer = {'a': 1.0}
  ```

### 2. 'hybrid' 类型
- 四层：`'h'` (household 家庭), `'s'` (school 学校), `'w'` (workplace 工作场所), `'c'` (community 社区)
- 默认值：
  ```python
  contacts = {'h': 2.0, 's': 20, 'w': 16, 'c': 20}
  beta_layer = {'h': 3.0, 's': 0.6, 'w': 0.6, 'c': 0.3}
  ```

### 3. 'synthpops' 类型
- 五层：`'h'`, `'s'`, `'w'`, `'c'`, `'l'` (LTCF 长期护理机构)
- 默认值与 hybrid 相同，额外加上 `'l'` 层

## 传递网络参数的方法

### 方法1：在创建 Sim 时传递（推荐）

```python
import covasim as cv

# 对于 'random' 类型
pars = {
    'pop_type': 'random',
    'contacts': {'a': 30},  # 修改接触数
    'beta_layer': {'a': 1.2}  # 修改传播率
}
sim = cv.Sim(pars=pars)
sim.run()

# 对于 'hybrid' 类型
pars = {
    'pop_type': 'hybrid',
    'contacts': {
        'h': 3.0,  # 家庭接触数
        's': 25,   # 学校接触数
        'w': 20,   # 工作场所接触数
        'c': 15    # 社区接触数
    },
    'beta_layer': {
        'h': 4.0,  # 家庭传播率
        's': 0.8,  # 学校传播率
        'w': 0.8,  # 工作场所传播率
        'c': 0.4   # 社区传播率
    }
}
sim = cv.Sim(pars=pars)
sim.run()
```

### 方法2：只修改部分层的参数

```python
import covasim as cv

# 只修改家庭层的参数，其他层使用默认值
pars = {
    'pop_type': 'hybrid',
    'contacts': {'h': 4.0},  # 只修改家庭接触数
    'beta_layer': {'h': 5.0}  # 只修改家庭传播率
}
sim = cv.Sim(pars=pars)
# 其他层（s, w, c）会使用默认值
sim.run()
```

### 方法3：使用关键字参数直接传递

```python
import covasim as cv

# 直接作为关键字参数传递
sim = cv.Sim(
    pop_type='hybrid',
    contacts={'h': 3.0, 's': 25, 'w': 20, 'c': 15},
    beta_layer={'h': 4.0, 's': 0.8, 'w': 0.8, 'c': 0.4}
)
sim.run()
```

### 方法4：创建后修改

```python
import covasim as cv

# 先创建模拟
sim = cv.Sim(pop_type='hybrid')

# 修改网络参数（在 initialize() 之前）
sim['contacts'] = {'h': 3.0, 's': 25, 'w': 20, 'c': 15}
sim['beta_layer'] = {'h': 4.0, 's': 0.8, 'w': 0.8, 'c': 0.4}

# 然后初始化
sim.initialize()
sim.run()
```

## 完整示例

### 示例1：修改 random 类型的网络参数

```python
import covasim as cv

pars = {
    'pop_size': 10000,
    'n_days': 90,
    'pop_type': 'random',
    'contacts': {'a': 30},      # 每人平均30个接触
    'beta_layer': {'a': 1.5}    # 传播率1.5
}

sim = cv.Sim(pars=pars)
sim.run()
sim.plot()
```

### 示例2：修改 hybrid 类型的网络参数

```python
import covasim as cv

pars = {
    'pop_size': 10000,
    'n_days': 90,
    'pop_type': 'hybrid',
    'contacts': {
        'h': 3.0,  # 家庭：平均3个家庭成员
        's': 30,   # 学校：平均30个同学
        'w': 25,   # 工作：平均25个同事
        'c': 10    # 社区：平均10个社区接触
    },
    'beta_layer': {
        'h': 4.0,  # 家庭传播率最高
        's': 0.7,  # 学校传播率中等
        'w': 0.7,  # 工作场所传播率中等
        'c': 0.2   # 社区传播率较低
    }
}

sim = cv.Sim(pars=pars)
sim.run()
sim.plot()
```

### 示例3：只修改特定层

```python
import covasim as cv

# 只增加学校接触数和传播率，其他使用默认值
pars = {
    'pop_type': 'hybrid',
    'contacts': {'s': 30},      # 只修改学校接触数
    'beta_layer': {'s': 1.0}    # 只修改学校传播率
}

sim = cv.Sim(pars=pars)
sim.run()
```

### 示例4：设置动态层

```python
import covasim as cv

pars = {
    'pop_type': 'hybrid',
    'contacts': {'h': 2.0, 's': 20, 'w': 16, 'c': 20},
    'beta_layer': {'h': 3.0, 's': 0.6, 'w': 0.6, 'c': 0.3},
    'dynam_layer': {
        'h': 0,  # 家庭层不是动态的
        's': 1,  # 学校层是动态的（可能因为假期等变化）
        'w': 1,  # 工作场所层是动态的
        'c': 0   # 社区层不是动态的
    }
}

sim = cv.Sim(pars=pars)
sim.run()
```

### 示例5：设置隔离和隔离因子

```python
import covasim as cv

pars = {
    'pop_type': 'hybrid',
    'contacts': {'h': 2.0, 's': 20, 'w': 16, 'c': 20},
    'beta_layer': {'h': 3.0, 's': 0.6, 'w': 0.6, 'c': 0.3},
    'iso_factor': {
        'h': 0.2,  # 隔离时家庭传播率降低到20%
        's': 0.05, # 隔离时学校传播率降低到5%
        'w': 0.05, # 隔离时工作场所传播率降低到5%
        'c': 0.05  # 隔离时社区传播率降低到5%
    },
    'quar_factor': {
        'h': 0.5,  # 隔离时家庭传播率降低到50%
        's': 0.1,  # 隔离时学校传播率降低到10%
        'w': 0.1,  # 隔离时工作场所传播率降低到10%
        'c': 0.1   # 隔离时社区传播率降低到10%
    }
}

sim = cv.Sim(pars=pars)
sim.run()
```

## 重要注意事项

### 1. 参数必须在 initialize() 之前设置

```python
# ✅ 正确：在 initialize() 之前设置
sim = cv.Sim(pop_type='hybrid', contacts={'h': 3.0})
sim.initialize()
sim.run()

# ❌ 错误：在 initialize() 之后设置网络参数可能无效
sim = cv.Sim(pop_type='hybrid')
sim.initialize()
sim['contacts'] = {'h': 3.0}  # 这可能不会生效
sim.run()
```

### 2. 层键必须匹配人口类型

```python
# ✅ 正确：hybrid 类型使用 h, s, w, c
sim = cv.Sim(
    pop_type='hybrid',
    contacts={'h': 3.0, 's': 20, 'w': 16, 'c': 20}
)

# ❌ 错误：random 类型不能使用 h, s, w, c
sim = cv.Sim(
    pop_type='random',
    contacts={'h': 3.0}  # 错误！random 类型应该使用 'a'
)

# ✅ 正确：random 类型使用 'a'
sim = cv.Sim(
    pop_type='random',
    contacts={'a': 30}
)
```

### 3. 部分修改会合并默认值

```python
# 只修改家庭层，其他层使用默认值
sim = cv.Sim(
    pop_type='hybrid',
    contacts={'h': 4.0}  # 只修改家庭层
)
# 结果：
# - h: 4.0 (用户指定)
# - s: 20 (默认值)
# - w: 16 (默认值)
# - c: 20 (默认值)
```

### 4. 查看当前网络参数

```python
import covasim as cv

sim = cv.Sim(pop_type='hybrid')
sim.initialize()

# 查看接触数
print(sim['contacts'])
# 输出：{'h': 2.0, 's': 20, 'w': 16, 'c': 20}

# 查看传播率
print(sim['beta_layer'])
# 输出：{'h': 3.0, 's': 0.6, 'w': 0.6, 'c': 0.3}

# 查看所有层键
print(sim.layer_keys())
# 输出：['h', 's', 'w', 'c']
```

## 默认值参考

### random 类型默认值
```python
contacts = {'a': 20}
beta_layer = {'a': 1.0}
dynam_layer = {'a': 0}
iso_factor = {'a': 0.2}
quar_factor = {'a': 0.3}
```

### hybrid 类型默认值
```python
contacts = {'h': 2.0, 's': 20, 'w': 16, 'c': 20}
beta_layer = {'h': 3.0, 's': 0.6, 'w': 0.6, 'c': 0.3}
dynam_layer = {'h': 0, 's': 0, 'w': 0, 'c': 0}
iso_factor = {'h': 0.3, 's': 0.1, 'w': 0.1, 'c': 0.1}
quar_factor = {'h': 0.6, 's': 0.2, 'w': 0.2, 'c': 0.2}
```

### synthpops 类型默认值
与 hybrid 相同，额外加上：
```python
contacts['l'] = 10
beta_layer['l'] = 1.5
dynam_layer['l'] = 0
iso_factor['l'] = 0.2
quar_factor['l'] = 0.3
```

## 常见问题

### Q1: 如何只修改一个层的参数？
A: 只传递要修改的层即可，其他层会使用默认值：
```python
sim = cv.Sim(pop_type='hybrid', contacts={'h': 4.0})
```

### Q2: 可以添加自定义层吗？
A: 可以，但需要先创建人口，然后添加层，再调用 `reset_layer_pars()`：
```python
sim = cv.Sim(pop_type='hybrid')
sim.initialize()
# 添加自定义层（见 t11_custom_layers.py 示例）
sim.people.contacts.add_layer(transport=layer)
sim.reset_layer_pars()
sim.initialize()
```

### Q3: 如何查看所有可用的层？
A: 使用 `sim.layer_keys()` 或 `sim.people.contacts.keys()`

### Q4: 参数设置后不生效怎么办？
A: 确保在 `initialize()` 之前设置参数，或者调用 `sim.reset_layer_pars()` 后重新 `initialize()`
