# 创建自定义人口类型和层结构

## 概述

如果你想创建完全自定义的人口类型，不使用默认的 `h`（家庭）、`s`（学校）、`w`（工作）、`c`（社区）层，可以按照以下方法操作。

## 方法1：完全自定义人口（推荐）

### 步骤1：创建自定义接触网络

```python
import numpy as np
import covasim as cv

# 定义自定义层键
custom_layer_keys = ['home', 'office', 'restaurant', 'gym']
pop_size = 10000

# 创建基本人口属性
uids = np.arange(pop_size, dtype=cv.default_int)
ages = np.random.uniform(18, 65, pop_size)
sexes = np.random.binomial(1, 0.5, pop_size)

# 创建自定义接触网络
contacts = cv.Contacts()

# 添加各个层
# 1. 家庭层（聚类结构）
home_contacts = cv.make_microstructured_contacts(pop_size, cluster_size=3.0)
contacts.add_layer(home=cv.Layer(**home_contacts, label='home'))

# 2. 办公室层（随机接触，只针对工作年龄）
work_ages = (ages >= 22) & (ages < 65)
work_indices = np.where(work_ages)[0]
office_contacts = cv.make_random_contacts(len(work_indices), n=15, mapping=work_indices)
contacts.add_layer(office=cv.Layer(**office_contacts, label='office'))

# 3. 餐厅层（随机接触）
restaurant_contacts = cv.make_random_contacts(pop_size, n=5)
contacts.add_layer(restaurant=cv.Layer(**restaurant_contacts, label='restaurant'))

# 4. 健身房层（随机接触，只针对特定年龄）
gym_ages = (ages >= 20) & (ages < 50)
gym_indices = np.where(gym_ages)[0]
gym_contacts = cv.make_random_contacts(len(gym_indices), n=8, mapping=gym_indices)
contacts.add_layer(gym=cv.Layer(**gym_contacts, label='gym'))
```

### 步骤2：创建人口字典

```python
popdict = {
    'uid': uids,
    'age': ages,
    'sex': sexes,
    'contacts': contacts,
    'layer_keys': custom_layer_keys
}
```

### 步骤3：创建模拟并设置参数

```python
# 创建模拟
sim = cv.Sim(pop_size=pop_size, n_days=90, pop_type='random')
sim.popdict = popdict  # 使用自定义人口

# 手动设置所有网络参数（必须为每个自定义层设置）
sim['contacts'] = {
    'home': 2.0,
    'office': 15,
    'restaurant': 5,
    'gym': 8
}

sim['beta_layer'] = {
    'home': 4.0,
    'office': 0.8,
    'restaurant': 0.5,
    'gym': 0.6
}

sim['dynam_layer'] = {
    'home': 0,
    'office': 0,
    'restaurant': 1,
    'gym': 1
}

sim['iso_factor'] = {
    'home': 0.3,
    'office': 0.05,
    'restaurant': 0.05,
    'gym': 0.05
}

sim['quar_factor'] = {
    'home': 0.6,
    'office': 0.1,
    'restaurant': 0.1,
    'gym': 0.1
}

# 初始化并运行
sim.initialize()
sim.run()
sim.plot()
```

## 方法2：使用 reset_layer_pars 自动设置

如果你已经创建了自定义人口，可以让系统自动检测层键并设置默认参数：

```python
sim = cv.Sim(pop_size=pop_size, n_days=90, pop_type='random')
sim.popdict = popdict  # 使用自定义人口

# 自动检测层键并设置默认参数
sim.reset_layer_pars()

# 然后可以手动调整特定层的参数
sim['beta_layer']['home'] = 5.0  # 只修改家庭传播率
sim['contacts']['gym'] = 10      # 只修改健身房接触数

sim.initialize()
sim.run()
```

## 方法3：使用辅助函数（最灵活）

创建一个辅助函数来简化自定义人口的创建：

```python
def create_custom_population(pop_size, layer_config):
    '''
    创建完全自定义的人口
    
    Args:
        pop_size: 人口大小
        layer_config: 层配置字典
    '''
    # 创建基本属性
    uids = np.arange(pop_size, dtype=cv.default_int)
    ages = np.random.uniform(18, 65, pop_size)
    sexes = np.random.binomial(1, 0.5, pop_size)
    
    # 创建接触网络
    contacts = cv.Contacts()
    layer_keys = []
    
    for layer_name, config in layer_config.items():
        layer_keys.append(layer_name)
        
        # 根据年龄范围筛选人员
        if config.get('age_range') is not None:
            min_age, max_age = config['age_range']
            age_mask = (ages >= min_age) & (ages < max_age)
            indices = np.where(age_mask)[0]
        else:
            indices = None
        
        # 创建接触
        if config.get('cluster_size') is not None:
            # 使用聚类结构（如家庭）
            if indices is not None:
                temp_contacts = cv.make_microstructured_contacts(len(indices), cluster_size=config['cluster_size'])
                temp_contacts['p1'] = indices[temp_contacts['p1']]
                temp_contacts['p2'] = indices[temp_contacts['p2']]
                layer_contacts = temp_contacts
            else:
                layer_contacts = cv.make_microstructured_contacts(pop_size, cluster_size=config['cluster_size'])
        else:
            # 使用随机接触
            n_contacts = config.get('n_contacts', 10)
            if indices is not None:
                layer_contacts = cv.make_random_contacts(len(indices), n=n_contacts, mapping=indices)
            else:
                layer_contacts = cv.make_random_contacts(pop_size, n=n_contacts)
        
        # 创建层
        layer = cv.Layer(**layer_contacts, label=layer_name)
        contacts.add_layer(**{layer_name: layer})
    
    # 创建人口字典
    popdict = {
        'uid': uids,
        'age': ages,
        'sex': sexes,
        'contacts': contacts,
        'layer_keys': layer_keys
    }
    
    return popdict, layer_keys

# 使用示例
custom_config = {
    'family': {
        'cluster_size': 3.5,  # 聚类结构
        'age_range': None     # 所有年龄
    },
    'workplace': {
        'n_contacts': 20,
        'age_range': (22, 65)  # 工作年龄
    },
    'shopping': {
        'n_contacts': 10,
        'age_range': None
    }
}

popdict, layer_keys = create_custom_population(8000, custom_config)

# 创建模拟
sim = cv.Sim(pop_size=8000, n_days=90, pop_type='random')
sim.popdict = popdict

# 设置网络参数
sim['contacts'] = {name: config.get('n_contacts', config.get('cluster_size', 10)) 
                    for name, config in custom_config.items()}
sim['beta_layer'] = {name: config.get('beta', 1.0) for name, config in custom_config.items()}
sim['dynam_layer'] = {name: 0 for name in layer_keys}
sim['iso_factor'] = {name: 0.1 for name in layer_keys}
sim['quar_factor'] = {name: 0.2 for name in layer_keys}

sim.initialize()
sim.run()
```

## 关键要点

1. **必须设置所有网络参数**：对于自定义层，必须手动设置 `contacts`、`beta_layer`、`dynam_layer`、`iso_factor`、`quar_factor`

2. **层键必须一致**：所有网络参数的字典键必须与 `layer_keys` 中的层名完全一致

3. **使用 popdict**：通过 `sim.popdict = popdict` 设置自定义人口，而不是依赖 `pop_type`

4. **在 initialize() 之前设置**：所有参数必须在调用 `sim.initialize()` 之前设置好

5. **可以使用 reset_layer_pars()**：调用 `sim.reset_layer_pars()` 可以自动为新层设置默认参数，然后可以手动调整

## 完整示例

查看 `examples/t11_custom_population_type.py` 获取完整示例代码。

## 常见问题

### Q1: 可以混合使用自定义层和默认层吗？
A: 可以，但需要确保所有层键在所有网络参数中都存在。

### Q2: 如何查看当前有哪些层？
A: 使用 `sim.layer_keys()` 或 `sim.people.contacts.keys()`

### Q3: 自定义层可以使用动态层吗？
A: 可以，设置 `dynam_layer[layer_name] = 1`，然后实现自定义的 Layer 类（见 `t11_dynamic_layers.py`）

### Q4: 如何保存和加载自定义人口？
A: 使用 `cv.save()` 和 `cv.load()`，或使用 `sim.save()` 和 `sim.load()`
