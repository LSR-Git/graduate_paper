# 人口缩放（Rescaling）参数说明

## 概述

这些参数用于**优化模拟性能**，允许你用较少的代理（agents）模拟更大的人口规模。这对于模拟百万级人口非常有用，可以大幅减少计算时间。

## 参数详解

### 1. `pop_scale` (默认值: 1)
**人口缩放因子**

- **作用**: 定义每个代理（agent）代表多少人
- **示例**: 
  - `pop_scale = 1`: 1个代理 = 1个人
  - `pop_scale = 10`: 1个代理 = 10个人
  - `pop_scale = 5`: 1个代理 = 5个人

**计算公式**:
```
总人口数 = pop_size × pop_scale
```

**示例**:
```python
# 模拟100万人口，但只用10万个代理
sim = cv.Sim(pop_size=100e3, pop_scale=10)
# 总人口 = 100,000 × 10 = 1,000,000
```

---

### 2. `scaled_pop` (默认值: None)
**总缩放人口数**

- **作用**: 直接指定总人口数，系统会自动计算 `pop_scale`
- **使用场景**: 当你明确知道总人口数，但不确定 `pop_scale` 时

**示例**:
```python
# 方式1：直接指定总人口
sim = cv.Sim(pop_size=100e3, scaled_pop=1e6)
# 系统会自动计算: pop_scale = 1e6 / 100e3 = 10

# 方式2：等价写法
sim = cv.Sim(pop_size=100e3, pop_scale=10)
```

---

### 3. `rescale` (默认值: True)
**是否启用动态缩放**

- **作用**: 控制是否在模拟过程中动态调整缩放因子
- **True (动态缩放)**: 随着疫情发展，逐步增加缩放因子
- **False (静态缩放)**: 从一开始就使用固定的缩放因子

**动态缩放的工作原理**:
1. 开始时：1个代理 = 1个人（`pop_scale = 1`）
2. 当感染人数达到阈值时，触发缩放
3. 将部分感染者"重置"为易感者，同时增加缩放因子
4. 例如：缩放后，1个代理 = 2个人

**静态缩放**:
- 从一开始：1个代理 = `pop_scale` 个人
- 所有结果都会自动乘以 `pop_scale`

---

### 4. `rescale_threshold` (默认值: 0.05)
**触发缩放的阈值**

- **作用**: 当"非易感者"（已感染/已康复）的比例超过此值时，触发动态缩放
- **默认值 0.05**: 即当5%的人口不再是易感者时触发

**计算方式**:
```
非易感者比例 = (感染者 + 康复者 + 死亡者) / 总代理数
```

**示例**:
```python
# 如果 pop_size = 100,000，rescale_threshold = 0.05
# 当非易感者人数 > 100,000 × 0.05 = 5,000 时，触发缩放
```

---

### 5. `rescale_factor` (默认值: 1.2)
**每次缩放的倍数**

- **作用**: 每次触发缩放时，缩放因子增加的倍数
- **默认值 1.2**: 每次缩放增加20%

**示例**:
```python
# 初始: 1个代理 = 1个人 (缩放因子 = 1)
# 第一次缩放后: 1个代理 = 1.2个人 (缩放因子 = 1.2)
# 第二次缩放后: 1个代理 = 1.44个人 (缩放因子 = 1.44)
# 以此类推，直到达到 pop_scale
```

---

### 6. `frac_susceptible` (默认值: 1.0)
**初始易感人群比例**

- **作用**: 定义初始时有多少比例的人口是易感的
- **默认值 1.0**: 100%的人口都是易感的
- **使用场景**: 如果部分人口已有免疫力（如疫苗接种），可以设置 < 1.0

**示例**:
```python
# 假设20%的人口已接种疫苗，不再易感
sim = cv.Sim(pop_size=100e3, frac_susceptible=0.8)
```

---

## 使用场景和示例

### 场景1：小规模模拟（不需要缩放）
```python
# 模拟10万人口，直接使用10万个代理
sim = cv.Sim(
    pop_size=100e3,
    pop_scale=1,        # 1个代理 = 1个人
    rescale=False       # 不需要动态缩放
)
```

### 场景2：大规模模拟（使用动态缩放）
```python
# 模拟100万人口，但只用20万个代理
sim = cv.Sim(
    pop_size=200e3,     # 20万个代理
    pop_scale=5,        # 最终：1个代理 = 5个人
    rescale=True,       # 启用动态缩放
    rescale_threshold=0.05,  # 5%阈值
    rescale_factor=1.2       # 每次增加20%
)
# 总人口 = 200,000 × 5 = 1,000,000
```

### 场景3：使用 scaled_pop 指定总人口
```python
# 直接指定总人口为50万
sim = cv.Sim(
    pop_size=100e3,     # 10万个代理
    scaled_pop=500e3    # 总人口50万
)
# 系统自动计算: pop_scale = 500e3 / 100e3 = 5
```

### 场景4：静态缩放（不推荐，但可用）
```python
# 从一开始就使用固定缩放
sim = cv.Sim(
    pop_size=100e3,
    pop_scale=10,
    rescale=False,      # 关闭动态缩放
    pop_infected=10     # 注意：初始感染数也要除以 pop_scale
)
# 总人口 = 100,000 × 10 = 1,000,000
# 所有结果会自动乘以10
```

---

## 动态缩放的工作原理（详细）

### 步骤1：初始状态
```
代理数: 200,000
pop_scale: 5 (目标)
当前缩放因子: 1
总人口: 200,000 × 1 = 200,000
```

### 步骤2：疫情开始
```
感染人数: 10,000
非易感者比例: 10,000 / 200,000 = 0.05
阈值: 0.05
触发条件: 0.05 >= 0.05 ✓ (触发缩放)
```

### 步骤3：执行缩放
```
缩放倍数: 1.2 (rescale_factor)
新缩放因子: 1 × 1.2 = 1.2
需要"重置"的人数: 10,000 × (1 - 1/1.2) = 1,667
剩余感染者: 10,000 - 1,667 = 8,333
总人口: 200,000 × 1.2 = 240,000
```

### 步骤4：继续模拟
```
如果再次达到阈值，继续缩放
最终达到: 缩放因子 = 5
总人口: 200,000 × 5 = 1,000,000
```

---

## 重要注意事项

### 1. 初始感染数的设置
- **动态缩放 (rescale=True)**: 使用实际的感染数
  ```python
  sim = cv.Sim(pop_size=100e3, pop_scale=10, rescale=True, pop_infected=50)
  ```

- **静态缩放 (rescale=False)**: 需要除以 `pop_scale`
  ```python
  sim = cv.Sim(pop_size=100e3, pop_scale=10, rescale=False, pop_infected=5)  # 50/10
  ```

### 2. 结果解释
- 所有结果（感染数、死亡数等）都会自动按缩放因子调整
- `sim.results['cum_infections']` 已经包含了缩放
- 不需要手动乘以 `pop_scale`

### 3. 性能建议
- **小规模 (< 20万)**: 使用 `pop_scale=1, rescale=False`
- **中等规模 (20-50万)**: 使用 `pop_scale=2-5, rescale=True`
- **大规模 (> 50万)**: 使用 `pop_scale=5-10, rescale=True`

### 4. 精度权衡
- 动态缩放通常与完整模拟结果几乎相同
- 静态缩放可能略有差异（特别是在疫情早期）
- 建议使用动态缩放（默认开启）

---

## 在你的代码中使用

```python
import numpy as np
import covasim as cv
import ContactNetwork

# 定义层级配置
custom_config_test = {
    'country': {
        'network_type': Enums.NetWorkType.scale_free.name,
        'm_connections': 3,
        'beta': 0.3,
    }   
}

countries_config = {'A': 0.6, 'B': 0.4}

# 创建自定义人口
custom_popdict, custom_keys = ContactNetwork.create_custom_population(
    100,  # 100个代理
    custom_config_test, 
    countries_config
)

# 创建模拟（使用缩放）
sim = cv.Sim(
    pop_size=100,        # 100个代理
    pop_scale=10,         # 1个代理 = 10个人
    scaled_pop=1000,      # 总人口1000人（等价于 pop_scale=10）
    rescale=True,         # 启用动态缩放
    rescale_threshold=0.05,  # 5%阈值
    rescale_factor=1.2,    # 每次增加20%
    n_days=90
)

sim.popdict = custom_popdict
sim.reset_layer_pars() 
sim.initialize()
sim.run()

# 结果已经自动缩放，不需要手动调整
print(f"总感染数: {sim.results['cum_infections'][-1]}")
# 这个数字已经代表了1000人的总感染数
```

---

## 总结

| 参数 | 作用 | 默认值 | 推荐值 |
|------|------|--------|--------|
| `pop_scale` | 缩放因子（1个代理代表多少人） | 1 | 根据总人口计算 |
| `scaled_pop` | 总人口数（自动计算pop_scale） | None | 如果知道总人口，用这个 |
| `rescale` | 是否启用动态缩放 | True | True（推荐） |
| `rescale_threshold` | 触发缩放的阈值 | 0.05 | 0.05（默认即可） |
| `rescale_factor` | 每次缩放的倍数 | 1.2 | 1.2（默认即可） |
| `frac_susceptible` | 初始易感人群比例 | 1.0 | 根据实际情况调整 |

**核心思想**: 用较少的代理模拟更多的人口，在保持精度的同时大幅提升性能！
